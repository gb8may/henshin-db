<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Henshin DB</title>
    <style>
      :root{
        --bg:#0b0e14;
        --panel:#111827;
        --panel2:#0f172a;
        --text:#e5e7eb;
        --muted:#94a3b8;
        --line:rgba(255,255,255,.08);
        --shadow: 0 16px 50px rgba(0,0,0,.55);
        --radius:16px;
        --radius2:22px;
        --pad:16px;
        --max:980px;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: radial-gradient(1200px 800px at 50% -10%, rgba(99,102,241,.25), transparent 55%),
                    radial-gradient(1000px 700px at 110% 10%, rgba(34,197,94,.12), transparent 50%),
                    radial-gradient(900px 700px at -10% 20%, rgba(239,68,68,.10), transparent 50%),
                    var(--bg);
        color:var(--text);
        overflow-x:hidden;
      }
      a{color:inherit;text-decoration:none}
      .app{
        min-height:100%;
        display:flex;
        flex-direction:column;
      }
      header{
        position:sticky;
        top:0;
        z-index:20;
        backdrop-filter: blur(10px);
        background: rgba(11,14,20,.72);
        border-bottom:1px solid var(--line);
      }
      .bar{
        max-width:var(--max);
        margin:0 auto;
        padding:12px var(--pad);
        display:flex;
        align-items:center;
        gap:12px;
      }
      .brand{
        display:flex;
        align-items:center;
        gap:10px;
        min-width:0;
      }
      .dot{
        width:10px;height:10px;border-radius:999px;
        background: linear-gradient(135deg, rgba(99,102,241,1), rgba(34,197,94,1));
        box-shadow:0 0 0 4px rgba(99,102,241,.15);
        flex:0 0 auto;
      }
      .brand h1{
        font-size:16px;
        margin:0;
        letter-spacing:.2px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .crumb{
        margin-left:auto;
        color:var(--muted);
        font-size:12px;
        white-space:nowrap;
      }
      main{
        flex:1;
        width:100%;
      }
      .container{
        max-width:var(--max);
        margin:0 auto;
        padding:16px var(--pad) 28px;
      }
      .title{
        margin:14px 0 10px;
        font-size:18px;
        letter-spacing:.2px;
      }
      .subtitle{
        margin:0 0 18px;
        color:var(--muted);
        font-size:13px;
        line-height:1.45;
      }

      .grid{
        display:grid;
        grid-template-columns: 1fr;
        gap:12px;
      }
      .card{
        background: linear-gradient(180deg, rgba(17,24,39,.92), rgba(15,23,42,.92));
        border:1px solid var(--line);
        border-radius: var(--radius2);
        padding:14px;
        box-shadow: 0 10px 28px rgba(0,0,0,.35);
      }
      .row{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
      }
      .chip{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:10px 12px;
        border-radius:999px;
        background: rgba(255,255,255,.06);
        border:1px solid var(--line);
        color:var(--text);
        font-weight:600;
        font-size:13px;
      }
      .chip small{font-weight:500;color:var(--muted)}
      .btn{
        appearance:none;
        border:1px solid var(--line);
        background: rgba(255,255,255,.06);
        color:var(--text);
        border-radius: 14px;
        padding:12px 12px;
        font-weight:700;
        font-size:14px;
        width:100%;
        text-align:left;
      }
      .btn:active{transform: translateY(1px)}
      .btnRow{
        display:grid;
        grid-template-columns: 1fr;
        gap:10px;
        margin-top:12px;
      }

      .topActions{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        margin:12px 0 8px;
      }
      .pill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:10px 12px;
        border-radius: 999px;
        background: rgba(255,255,255,.06);
        border:1px solid var(--line);
        font-size:13px;
        color:var(--text);
        font-weight:700;
      }
      .pill.secondary{
        color:var(--muted);
        font-weight:600;
      }
      .pill:active{transform: translateY(1px)}

      .input{
        width:100%;
        padding:12px 12px;
        border-radius: 14px;
        border:1px solid var(--line);
        background: rgba(255,255,255,.04);
        color:var(--text);
        outline:none;
        font-size:14px;
      }
      .list{
        margin-top:10px;
        display:flex;
        flex-direction:column;
        gap:10px;
      }
      .item{
        display:flex;
        gap:12px;
        align-items:flex-start;
        padding:12px;
        border-radius: var(--radius2);
        background: rgba(255,255,255,.04);
        border:1px solid var(--line);
      }
      .thumb{
        width:42px;height:42px;
        border-radius:12px;
        background: rgba(255,255,255,.05);
        border:1px solid var(--line);
        overflow:hidden;
        flex:0 0 auto;
        display:flex;
        align-items:center;
        justify-content:center;
        color:var(--muted);
        font-weight:800;
      }
      .thumb img{width:100%;height:100%;object-fit:cover;display:block}
      .itemMain{min-width:0;flex:1}
      .itemTitle{
        margin:0;
        font-size:14px;
        font-weight:800;
        letter-spacing:.2px;
        line-height:1.2;
      }
      .itemMeta{
        margin:6px 0 0;
        font-size:12px;
        color:var(--muted);
        line-height:1.35;
      }
      .tagRow{
        margin-top:8px;
        display:flex;
        gap:8px;
        flex-wrap:wrap;
      }
      .tag{
        font-size:11px;
        color:rgba(229,231,235,.92);
        background: rgba(99,102,241,.14);
        border:1px solid rgba(99,102,241,.28);
        padding:6px 10px;
        border-radius:999px;
        white-space:nowrap;
      }

      .empty{
        margin-top:14px;
        padding:14px;
        border-radius: var(--radius2);
        border:1px dashed var(--line);
        color:var(--muted);
        font-size:13px;
        line-height:1.45;
      }

      footer{
        border-top:1px solid var(--line);
        color:var(--muted);
        font-size:12px;
        padding:14px var(--pad);
        text-align:center;
      }

      .overlay{
        position:fixed;
        inset:0;
        background: rgba(0,0,0,.62);
        display:none;
        align-items:center;
        justify-content:center;
        padding: 18px;
        z-index:50;
      }
      .overlay.open{display:flex}
      .modal{
        width:min(560px, 100%);
        max-height: min(86vh, 720px);
        overflow:auto;
        border-radius: 22px;
        background: linear-gradient(180deg, rgba(17,24,39,.98), rgba(15,23,42,.98));
        border:1px solid var(--line);
        box-shadow: var(--shadow);
      }
      .modalHeader{
        position:sticky;
        top:0;
        background: rgba(17,24,39,.92);
        backdrop-filter: blur(10px);
        border-bottom:1px solid var(--line);
        padding: 12px 14px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        z-index:1;
      }
      .modalHeader h3{
        margin:0;
        font-size:14px;
        font-weight:900;
        letter-spacing:.2px;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
      }
      .close{
        border:1px solid var(--line);
        background: rgba(255,255,255,.06);
        color:var(--text);
        border-radius: 12px;
        padding:10px 12px;
        font-weight:800;
        font-size:13px;
      }
      .modalBody{padding:14px}
      .heroImg{
        width:100%;
        border-radius: 18px;
        overflow:hidden;
        border:1px solid var(--line);
        background: rgba(255,255,255,.04);
      }
      .heroImg img{width:100%;height:auto;display:block}
      .kv{
        margin-top:12px;
        display:grid;
        grid-template-columns: 1fr;
        gap:10px;
      }
      .kvBlock{
        padding:12px;
        border-radius: 18px;
        border:1px solid var(--line);
        background: rgba(255,255,255,.04);
      }
      .kvLabel{
        font-size:11px;
        color:var(--muted);
        letter-spacing:.12em;
        text-transform:uppercase;
        margin:0 0 6px;
      }
      .kvValue{
        margin:0;
        font-size:13px;
        line-height:1.45;
        color:var(--text);
        white-space:pre-wrap;
      }

      @media (min-width: 640px){
        .grid{grid-template-columns: 1fr 1fr}
        .btnRow{grid-template-columns: 1fr}
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>

  <body>
    <div class="app">
      <header>
        <div class="bar">
          <div class="brand">
            <div class="dot"></div>
            <h1 id="headerTitle">Henshin DB</h1>
          </div>
          <div class="crumb" id="crumb"></div>
        </div>
      </header>

      <main>
        <div class="container">
          <section id="viewHome" style="display:none">
            <div class="title">Home</div>
            <p class="subtitle">Escolha uma franquia para navegar.</p>

            <div class="grid">
              <div class="card">
                <div class="row">
                  <div class="chip">Kamen Rider <small>Riders</small></div>
                </div>
                <div class="btnRow">
                  <button class="btn" data-go-franchise="kamen rider">Abrir</button>
                </div>
              </div>

              <div class="card">
                <div class="row">
                  <div class="chip">Super Sentai <small>Equipes</small></div>
                </div>
                <div class="btnRow">
                  <button class="btn" data-go-franchise="super sentai">Abrir</button>
                </div>
              </div>

              <div class="card">
                <div class="row">
                  <div class="chip">Metal Hero <small>Heróis</small></div>
                </div>
                <div class="btnRow">
                  <button class="btn" data-go-franchise="metal hero">Abrir</button>
                </div>
              </div>
            </div>
          </section>

          <section id="viewFranchise" style="display:none">
            <div class="title" id="frTitle"></div>
            <p class="subtitle" id="frSubtitle"></p>

            <div class="topActions">
              <button class="pill secondary" id="btnBackHome">Home</button>
              <span class="pill secondary" id="frPill"></span>
            </div>

            <div class="grid">
              <div class="card">
                <div class="row">
                  <div class="chip">Personagens <small>lista completa</small></div>
                </div>
                <div class="btnRow">
                  <button class="btn" id="btnGoCharacters">Abrir lista</button>
                </div>
              </div>

              <div class="card">
                <div class="row">
                  <div class="chip">Glossário <small>termos</small></div>
                </div>
                <div class="btnRow">
                  <button class="btn" id="btnGoGlossary">Abrir glossário</button>
                </div>
              </div>
            </div>
          </section>

          <section id="viewCharacters" style="display:none">
            <div class="title" id="charsTitle"></div>
            <p class="subtitle" id="charsSubtitle"></p>

            <div class="topActions">
              <button class="pill secondary" id="btnBackFranchise">Voltar</button>
              <button class="pill" id="btnReload">Recarregar</button>
            </div>

            <input class="input" id="searchInput" placeholder="Buscar pelo nome (EN/PT/JP)..." />

            <div class="list" id="charsList"></div>
            <div class="empty" id="charsEmpty" style="display:none"></div>
          </section>

          <section id="viewGlossary" style="display:none">
            <div class="title">Glossário</div>
            <p class="subtitle">Tela placeholder. Se você já tiver a tabela do glossário no Supabase, eu conecto aqui igual a de personagens.</p>

            <div class="topActions">
              <button class="pill secondary" id="btnBackFromGlossary">Voltar</button>
            </div>

            <div class="empty">Me diga o nome da sua tabela de glossário e as colunas principais (ex: term_en, term_jp, term_pt, definition) que eu ajusto em 1 mensagem.</div>
          </section>
        </div>
      </main>

      <footer>v0.1 · Henshin DB · Author: Mayara Gouveia</footer>
    </div>

    <div class="overlay" id="overlay">
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modalHeader">
          <h3 id="modalTitle"></h3>
          <button class="close" id="btnClose">Fechar</button>
        </div>
        <div class="modalBody" id="modalBody"></div>
      </div>
    </div>

    <script>
      const SUPABASE_URL = "https://grvmisyiyxzlqfqgponm.supabase.co";
      const SUPABASE_ANON_KEY = "https://grvmisyiyxzlqfqgponm.supabase.co";

      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const views = {
        home: document.getElementById("viewHome"),
        franchise: document.getElementById("viewFranchise"),
        characters: document.getElementById("viewCharacters"),
        glossary: document.getElementById("viewGlossary"),
      };

      const headerTitle = document.getElementById("headerTitle");
      const crumb = document.getElementById("crumb");

      const frTitle = document.getElementById("frTitle");
      const frSubtitle = document.getElementById("frSubtitle");
      const frPill = document.getElementById("frPill");

      const charsTitle = document.getElementById("charsTitle");
      const charsSubtitle = document.getElementById("charsSubtitle");
      const searchInput = document.getElementById("searchInput");
      const charsList = document.getElementById("charsList");
      const charsEmpty = document.getElementById("charsEmpty");

      const overlay = document.getElementById("overlay");
      considerOverlayClickClose();

      const modalTitle = document.getElementById("modalTitle");
      const modalBody = document.getElementById("modalBody");
      document.getElementById("btnClose").addEventListener("click", closeModal);

      let state = {
        view: "home",
        franchise: null,
        characters: [],
      };

      function showView(name) {
        Object.values(views).forEach(v => v.style.display = "none");
        views[name].style.display = "block";
        state.view = name;
        renderHeader();
      }

      function renderHeader() {
        const fr = state.franchise;
        if (state.view === "home") {
          headerTitle.textContent = "Henshin DB";
          crumb.textContent = "";
          return;
        }
        if (state.view === "franchise") {
          headerTitle.textContent = "Henshin DB";
          crumb.textContent = fr ? formatFranchise(fr) : "";
          return;
        }
        if (state.view === "characters") {
          headerTitle.textContent = "Personagens";
          crumb.textContent = fr ? formatFranchise(fr) : "";
          return;
        }
        if (state.view === "glossary") {
          headerTitle.textContent = "Glossário";
          crumb.textContent = fr ? formatFranchise(fr) : "";
          return;
        }
      }

      function formatFranchise(fr) {
        if (fr === "kamen rider") return "Kamen Rider";
        if (fr === "super sentai") return "Super Sentai";
        if (fr === "metal hero") return "Metal Hero";
        return fr;
      }

      function openFranchise(fr) {
        state.franchise = fr;
        frTitle.textContent = formatFranchise(fr);
        frSubtitle.textContent = "Escolha o que você quer explorar dentro desta franquia.";
        frPill.textContent = formatFranchise(fr);
        showView("franchise");
      }

      function goCharacters() {
        const fr = state.franchise;
        charsTitle.textContent = `Personagens · ${formatFranchise(fr)}`;
        charsSubtitle.textContent = "Lista completa em ordem alfabética. Toque em um item para ver detalhes.";
        searchInput.value = "";
        showView("characters");
        loadCharacters();
      }

      function goGlossary() {
        showView("glossary");
      }

      async function loadCharacters() {
        charsList.innerHTML = "";
        charsEmpty.style.display = "none";

        const fr = state.franchise;
        if (!fr) {
          charsEmpty.textContent = "Selecione uma franquia na Home.";
          charsEmpty.style.display = "block";
          return;
        }

        const { data, error } = await sb
          .from("characters")
          .select("id,name_en,name_pt,name_jp,romaji,franchise,year,description,powers,equipment,tags,civil_name,actor_name,image_url,image_slug")
          .eq("franchise", fr)
          .order("name_en", { ascending: true });

        if (error) {
          charsEmpty.textContent = `Erro ao carregar: ${error.message}`;
          charsEmpty.style.display = "block";
          return;
        }

        state.characters = Array.isArray(data) ? data : [];
        renderCharacters(state.characters);
      }

      function renderCharacters(items) {
        charsList.innerHTML = "";

        if (!items.length) {
          charsEmpty.textContent = "Nenhum personagem encontrado.";
          charsEmpty.style.display = "block";
          return;
        }

        charsEmpty.style.display = "none";

        for (const c of items) {
          const el = document.createElement("div");
          el.className = "item";
          el.tabIndex = 0;

          const thumb = document.createElement("div");
          thumb.className = "thumb";

          const imgUrl = getImageUrl(c);
          if (imgUrl) {
            const img = document.createElement("img");
            img.loading = "lazy";
            img.alt = c.name_en || "character";
            img.src = imgUrl;
            img.onerror = () => {
              img.remove();
              thumb.textContent = initials(c.name_en || c.name_pt || "?");
            };
            thumb.appendChild(img);
          } else {
            thumb.textContent = initials(c.name_en || c.name_pt || "?");
          }

          const main = document.createElement("div");
          main.className = "itemMain";

          const title = document.createElement("p");
          title.className = "itemTitle";
          title.textContent = c.name_pt || c.name_en || "Sem nome";

          const meta = document.createElement("p");
          meta.className = "itemMeta";
          const metaParts = [];
          if (c.name_en && c.name_pt && c.name_en !== c.name_pt) metaParts.push(c.name_en);
          if (c.year) metaParts.push(String(c.year));
          if (c.name_jp) metaParts.push(c.name_jp);
          meta.textContent = metaParts.join(" · ");

          main.appendChild(title);
          main.appendChild(meta);

          const tagRow = document.createElement("div");
          tagRow.className = "tagRow";
          const tags = safeJsonArray(c.tags);
          for (const t of tags.slice(0, 3)) {
            const tg = document.createElement("span");
            tg.className = "tag";
            tg.textContent = String(t);
            tagRow.appendChild(tg);
          }
          if (tagRow.childElementCount) main.appendChild(tagRow);

          el.appendChild(thumb);
          el.appendChild(main);

          el.addEventListener("click", () => openCharacterModal(c));
          el.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") openCharacterModal(c);
          });

          charsList.appendChild(el);
        }
      }

      function openCharacterModal(c) {
        modalTitle.textContent = c.name_pt || c.name_en || "Detalhes";
        modalBody.innerHTML = "";

        const imgUrl = getImageUrl(c);
        if (imgUrl) {
          const hero = document.createElement("div");
          hero.className = "heroImg";
          const img = document.createElement("img");
          img.alt = c.name_en || "character";
          img.src = imgUrl;
          img.loading = "eager";
          img.onerror = () => hero.remove();
          hero.appendChild(img);
          modalBody.appendChild(hero);
        }

        const kv = document.createElement("div");
        kv.className = "kv";

        const blocks = [];

        blocks.push(block("Nome (EN)", c.name_en));
        blocks.push(block("Nome (JP)", c.name_jp));
        blocks.push(block("Romaji", c.romaji));
        blocks.push(block("Ano", c.year ? String(c.year) : null));
        blocks.push(block("Nome civil", c.civil_name));
        blocks.push(block("Ator", c.actor_name));
        blocks.push(block("Descrição", c.description));
        blocks.push(block("Poderes", c.powers));
        blocks.push(block("Equipamentos", c.equipment));

        for (const b of blocks) if (b) kv.appendChild(b);

        modalBody.appendChild(kv);

        overlay.classList.add("open");
        document.body.style.overflow = "hidden";
      }

      function block(label, value) {
        if (value === null || value === undefined) return null;
        const v = String(value).trim();
        if (!v) return null;

        const w = document.createElement("div");
        w.className = "kvBlock";

        const l = document.createElement("p");
        l.className = "kvLabel";
        l.textContent = label;

        const p = document.createElement("p");
        p.className = "kvValue";
        p.textContent = v;

        w.appendChild(l);
        w.appendChild(p);
        return w;
      }

      function closeModal() {
        overlay.classList.remove("open");
        document.body.style.overflow = "";
      }

      function considerOverlayClickClose() {
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) closeModal();
        });
        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModal();
        });
      }

      function initials(s) {
        const t = String(s).trim();
        if (!t) return "?";
        const parts = t.split(/\s+/).slice(0,2);
        return parts.map(x => x[0]?.toUpperCase() || "").join("") || "?";
      }

      function safeJsonArray(v) {
        try {
          if (Array.isArray(v)) return v;
          if (typeof v === "string" && v.trim().startsWith("[")) return JSON.parse(v);
          return [];
        } catch {
          return [];
        }
      }

      function getImageUrl(c) {
        if (c.image_url && String(c.image_url).trim()) return String(c.image_url).trim();

        const slug = (c.image_slug && String(c.image_slug).trim())
          ? String(c.image_slug).trim()
          : slugify(c.name_en || c.name_pt || "");

        if (!slug) return null;

        return `${SUPABASE_URL}/storage/v1/object/public/henshin-images/${slug}.png`;
      }

      function slugify(s) {
        return String(s)
          .normalize("NFKD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "");
      }

      function applySearchFilter() {
        const q = searchInput.value.trim().toLowerCase();
        if (!q) {
          renderCharacters(state.characters);
          return;
        }
        const filtered = state.characters.filter(c => {
          const hay = [
            c.name_en, c.name_pt, c.name_jp, c.romaji,
            c.description, c.civil_name, c.actor_name
          ].filter(Boolean).join(" ").toLowerCase();
          return hay.includes(q);
        });
        renderCharacters(filtered);
      }

      document.querySelectorAll("[data-go-franchise]").forEach(btn => {
        btn.addEventListener("click", () => openFranchise(btn.getAttribute("data-go-franchise")));
      });

      document.getElementById("btnBackHome").addEventListener("click", () => showView("home"));
      document.getElementById("btnGoCharacters").addEventListener("click", goCharacters);
      document.getElementById("btnGoGlossary").addEventListener("click", goGlossary);

      document.getElementById("btnBackFranchise").addEventListener("click", () => showView("franchise"));
      document.getElementById("btnReload").addEventListener("click", loadCharacters);

      document.getElementById("btnBackFromGlossary").addEventListener("click", () => showView("franchise"));

      searchInput.addEventListener("input", () => applySearchFilter());

      showView("home");
    </script>
  </body>
</html>